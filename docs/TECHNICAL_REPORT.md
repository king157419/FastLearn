# DeepTutor 技术报告

## 目录

1. [项目概述](#1-项目概述)
2. [技术栈](#2-技术栈)
3. [系统架构](#3-系统架构)
4. [对话流程详解](#4-对话流程详解)
5. [多智能体系统](#5-多智能体系统)
6. [Memory 系统](#6-memory-系统)
7. [数据流动详解](#7-数据流动详解)

---

## 1. 项目概述

**DeepTutor** 是一个基于 **微服务架构** 的 AI 个性化学习助手，采用 **多智能体协作** 模式实现复杂的教育功能。

### 核心功能模块

| 模块 | 功能描述 |
|------|----------|
| **Chat** | 轻量级对话，支持多轮对话、跨会话记忆 |
| **Solve** | 问题求解，双循环架构（分析循环 + 求解循环） |
| **Research** | 深度研究，动态主题队列，三阶段流程 |
| **Question** | 自定义/模仿问题生成与验证 |
| **Guide** | 交互式学习指导，可视化教学 |
| **Co-Writer** | AI 协作写作，支持 TTS |
| **IdeaGen** | 自动化研究点子生成 |
| **Memory** | 跨会话记忆系统，用户画像与知识追踪 |

---

## 2. 技术栈

### 2.1 后端技术栈

| 层级 | 技术 | 用途 |
|------|------|------|
| **语言** | Python 3.10+ | 核心开发语言 |
| **框架** | FastAPI | 高性能异步 API 框架 |
| **异步** | asyncio/await | 异步 I/O 处理 |
| **数据库** | PostgreSQL + pgvector | 结构化数据 + 向量存储 |
| **ORM** | SQLAlchemy | 数据库 ORM |
| **WebSocket** | FastAPI WebSocket | 实时双向通信 |
| **配置管理** | Pydantic + YAML | 配置解析与验证 |

### 2.2 前端技术栈

| 层级 | 技术 | 用途 |
|------|------|------|
| **框架** | Next.js 16 + React 19 | SSR React 框架 |
| **语言** | TypeScript | 类型安全 JavaScript |
| **样式** | Tailwind CSS | 实用优先 CSS |
| **状态管理** | React Context + Hooks | 全局状态管理 |
| **图标** | Lucide React | UI 图标库 |

### 2.3 AI/LLM 技术栈

| 组件 | 技术 |
|------|------|
| **LLM 抽象层** | 统一工厂模式，支持多提供商 |
| **支持提供商** | OpenAI, Anthropic, DeepSeek, 智谱AI, 本地(Ollama) |
| **向量数据库** | pgvector (PostgreSQL 扩展) |
| **嵌入模型** | text-embedding-3-small, deepseek-embeddings |

### 2.4 配置架构

```
config/
├── main.yaml              # 主配置文件
├── agents.yaml            # 统一 Agent 参数配置
├── prompts/               # 提示词模板
└── tools/                 # 工具配置
```

---

## 3. 系统架构

### 3.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         前端 (Next.js)                          │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────┐  │
│  │ Chat    │  │  Solve   │  │ Research │  │ Question │  │Guide   │  │
│  │ Page    │  │  Page    │  │  Page    │  │  Page    │  │ Page    │  │
│  └────┬────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  │
│       │           │            │            │            │        │
│       └───────────┴────────────┴────────────┴────────────┴────────┘   │
│                          │                                         │
│                  ┌───────▼────────┐                            │
│                  │  Global Context │                            │
│                  │  (状态管理)      │                            │
│                  └────────┬────────┘                            │
│                           │                                         │
├───────────────────────────┼─────────────────────────────────────────┤
│                           │                                         │
│                    WebSocket │ (实时通信 + 流式响应)                │
│                           │                                         │
├───────────────────────────┼─────────────────────────────────────────┤
│                           │                                         │
│                           ▼                                         │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                       FastAPI Backend                         │  │
│  │  ┌────────────────────────────────────────────────────────┐  │  │
│  │  │  ┌─────────┐ ┌────────┐ ┌────────┐ ┌──────────┐ ┌────────┐ │  │  │
│  │  │  │ Chat    │ │ Solve  │ │Research│ │Question│ │ Guide  │ │  │  │
│  │  │  │ Router │ │ Router │ │ Router │ │ Router │ │ Router │ │  │  │
│  │  │  └────┬────┘ └───┬────┘ └───┬────┘ └───┬──────┘ └───┬────┘ │  │  │
│  │  │       │         │        │        │          │        │  │  │  │
│  │  │  ┌────▼─────┴───▼──────┴───▼────┴───┴──────────┴────▼────┐ │  │  │
│  │  │  │              Multi-Agent System                      │ │  │  │
│  │  │  │  ┌───────────┐ ┌─────────────┐ ┌─────────────────┐ │ │  │
│  │  │  │  │ │ChatAgent│ │ Solve Agents │ │  Memory Agents │ │ │  │  │
│  │  │  │  └───────────┘ └─────────────┘ └─────────────────┘ │ │  │  │
│  │  │  │                                                    │ │  │  │
│  │  │  └────────────────────────────────────────────────────┘ │  │  │
│  │  │                                                         │  │  │
│  │  │  ┌───────────────────────────────────────────────────────┐ │  │  │
│  │  │  │              Core Services Layer                        │ │  │  │
│  │  │  │  ┌─────────┐ ┌────────┐ ┌──────┐ ┌─────────┐ ┌───────┐ │ │  │  │
│  │  │  │  │ LLM     │ │Config │ │Prompt│ │Memory   │ │Tools  │ │ │  │  │
│  │  │  │  │ Factory│ │Loader │ │Manager│ │System   │ ││       │ │ │  │ │
│  │  │  │  └─────────┘ └────────┘ └──────┘ └─────────┘ └───────┘ │ │  │  │
│  │  │  └───────────────────────────────────────────────────────┘ │  │  │
│  │  │                                                         │  │  │ │
│  │  └────────────────────────────────────────────────────────────┘ │  │  │
│  │                                                           │  │  │
│  └──────────────────────────────────────────────────────────────┘ │  │  │
│                                                              │  │  │
│  ┌───────────────────────────────────────────────────────────────┐ │  │  │
│  │                     Data Layer                             │  │  │  │
│  │  ┌─────────────┐  ┌──────────────┐  ┌─────────────────┐      │  │  │  │
│  │  │ PostgreSQL  │  │ pgvector      │  │  JSON Files      │      │  │  │  │
│  │  │ (user_profiles│  │ (embeddings)  │  │  (sessions)     │      │  │  │  │
│  │  │session_summaries)│  │              │  │                 │      │  │  │  │
│  │  └─────────────┘  └──────────────┘  └─────────────────┘      │  │  │  │
│  └───────────────────────────────────────────────────────────────┘  │  │  │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. 对话流程详解

### 4.1 对话时序图

```
用户                    前端                   后端                    Memory System            LLM
 │                      │                       │                           │
 │  1.发送消息            │                       │                           │
 ├─────────────────────>│                       │                           │
 │                      │  2. 创建 WebSocket 连接   │                           │
 │                      ├───────────────────────>│                           │
 │                      │                       │                           │
 │                      │  3. 获取 user_id        │                           │
 │                      │  ├──────────────────────>│                           │
 │                      │  │  localStorage.get()    │                           │
 │                      │  │<──────────────────────│                           │
 │                      │                       │                           │
 │                      │  4. 创建/获取 session    │                           │
 │                      │  ├───────────────────────>│                           │
 │                      │  │  SessionManager       │                           │
 │                      │  │<──────────────────────│                           │
 │                      │                       │                           │
 │                      │  5. 创建 ChatAgent       │                           │
 │                      │  ├───────────────────────>│                           │
 │                      │  │  BaseAgent.__init__() │                           │
 │                      │  │<──────────────────────│                           │
 │                      │                       │                           │
 │                      │  6. Memory 检索          │                           │
 │                      │  ├────────────────────────────────────────────────>│
 │                      │  │  RetrievalAgent.process()│                           │
 │                      │  │  │  - 查询用户画像        │                           │
 │                      │  │  │  - 检索历史会话摘要  │                           │
 │                      │  │  │  - 生成上下文          │                           │
 │                      │  │<─────────────────────────────────────────────│
 │                      │  │                       │                           │
 │                      │  7. 构建 messages        │                           │
 │                      │  │  [system, context, history, user_message]    │           │
 │                      │  │                       │                           │
 │                      │  8. 流式 LLM 调用       │                           │
 │                      │  ├────────────────────────────────────────────────>│
 │                      │  │  stream_llm()          │                           │
 │                      │  │  │  LLM Factory         │                           │
 │                      │  │  │  - 多提供商路由       │                           │
 │                      │  │  │  - 重试机制          │                           │
 │                      │  │<─────────────────────────────────────────────│
 │                      │  │  │                   │                           │
 │                      │  │  │  ◄─── chunks ────┐     │                           │
 │                      │  │  │               │     │                           │
 │                      │  │<───────────────┘     │                           │
 │                      │  │                       │                           │
 │                      │  9. 流式返回响应          │                           │
 │                      │  ├──────────────────────>│                           │
 │                      │  │  {"type":"stream",    │                           │
 │                      │  │   "content":"..."}     │                           │
 │                      │  │<──────────────────────│                           │
 │                      │                       │                           │
 │                      │ 10. 用户关闭连接         │                           │
 │                      │  ├───────────────────────>│                           │
 │                      │  │                       │                           │
 │                      │  11. 触发 Session Summary (后台)│                           │
 │                      │  │  ├────────────────────────────────────────>│
 │                      │  │  │  SummarizerAgent    │                           │
 │                      │  │  │  - 检查触发条件      │                           │
 │                      │  │  │  - 生成结构化摘要    │                           │
 │                      │  │  │  │  - LLM JSON Mode    │                           │
 │                      │  │  │  └──────────────────┘  │                           │
 │                      │  │  │                       │                           │
 │                      │  │  ├──────────────────────────────────────>│
 │                      │  │  │  ProfileAgent       │                           │
 │                      │  │  │  - 推断用户偏好      │                           │
 │                      │  │  │  - 更新统计数据      │                           │
 │                      │  │  │<──────────────────────────────────────│
 │                      │  │  │                       │                           │
 │                      │  │  ◄─────── 保存到数据库 ──┘                           │
 │                      │  │                       │                           │
 │                      │<──────────────────────│                           │
 │                      │                       │                           │
 │ 12. 更新 UI 显示       │                       │                           │
 │<─────────────────────┘                       │                           │
```

### 4.2 关键代码流程

#### 4.2.1 WebSocket 连接建立

```python
# src/api/routers/chat.py
@router.websocket("/chat")
async def websocket_chat(websocket: WebSocket):
    await websocket.accept()

    # 跟踪会话状态（用于 Memory 系统）
    current_session_id = None
    current_user_id = "default_user"

    try:
        while True:
            data = await websocket.receive_json()
            message = data.get("message", "")
            session_id = data.get("session_id")
            user_id = data.get("user_id", "default_user")

            # ... 处理对话 ...
```

#### 4.4.2 ChatAgent 处理流程

```python
# src/agents/chat/chat_agent.py
class ChatAgent(BaseAgent):
    async def process(self, message: str, history: list[dict], ...):
        # 1. 检索 Memory 上下文
        context, sources = await self.retrieve_context(
            message=message,
            user_id=user_id,
            days=7  # 检索最近7天的记忆
        )

        # 2. 构建消息数组
        messages = self.build_messages(message, history, context)

        # 3. 流式生成响应
        async for chunk in self.stream_llm(...):
            yield chunk

        return {"response": full_response, "sources": sources}
```

#### 4.4.3 Memory 检索流程

```python
# src/agents/chat/chat_agent.py
async def retrieve_context(self, message: str, user_id: str):
    if self.enable_memory and self.user_id:
        from src.agents.memory import get_memory_context

        memory_context = await get_memory_context(
            user_id=self.user_id,
            query=message,
            days=7
        )

        if memory_context:
            context_parts.append(f"[Cross-Session Memory]\n{memory_context}")
            sources["memory"].append({...})
```

---

## 5. 多智能体系统

### 5.1 BaseAgent 统一基类

所有 Agent 继承自 `BaseAgent`，提供统一的能力：

```python
class BaseAgent(ABC):
    """统一 Agent 基类"""

    # 核心能力
    - LLM 配置管理 (api_key, base_url, model)
    - Agent 参数 (temperature, max_tokens) from agents.yaml
    - Prompt 加载 via PromptManager
    - 统一 LLM 调用接口 (call_llm, stream_llm)
    - Token 追踪
    - 日志记录

    # 子类必须实现
    @abstractmethod
    async def process(self, *args, **kwargs) -> Any:
        """主要处理逻辑"""
```

### 5.2 智能体类型

#### 5.2.1 对话智能体 (ChatAgent)

```python
class ChatAgent(BaseAgent):
    """
    轻量级对话智能体

    能力：
    - 多轮对话管理
    - 历史截断（避免 token 超限）
    - Memory 系统集成
    - RAG 知识检索
    - Web 搜索集成
    - 流式响应生成
    """

    async def process(self, message, history, enable_rag, ...):
        # 1. 检索跨会话记忆
        # 2. 构建 messages
        # 3. 流式生成响应
        pass
```

#### 5.2.2 Memory 智能体族

| Agent | 职责 |
|-------|------|
| **RetrievalAgent** | 检索相关历史记忆，生成上下文 |
| **SummarizerAgent** | 分析长对话，生成结构化摘要 |
| **ProfileAgent** | 隐式学习用户偏好，更新用户画像 |

```python
# 检索 Agent
class RetrievalAgent(BaseAgent):
    async def process(self, user_id, query, days):
        # 1. 获取用户画像
        # 2. 检索会话摘要
        # 3. LLM 生成上下文
        return {"context": "...", "weak_points": [...]}

# 摘要 Agent
class SummarizerAgent(BaseAgent):
    async def process(self, session_id, user_id, messages, force):
        # 1. 检查触发条件
        # 2. LLM 生成 JSON 摘要
        # 3. 保存到数据库
        # 4. 更新用户画像
        return {"summary": {...}, "statistics": {...}}
```

#### 5.2.3 Solve 模块 - 双循环架构

```
                    ┌──────────────────────┐
                    │    MainSolver         │  主控制器
                    └──────────┬───────────┘
                               │
                ┌───────────────┴──────────────┐
                │                                │
         ┌────▼─────────┐              ┌───▼──────────────┐
         │  Analysis Loop │              │   Solve Loop      │
         │  (分析循环)    │              │   (求解循环)      │
         └────┬─────────┘              └───┬──────────────┘
              │                                │
    ┌─────────┴────────┐          ┌────┴─────────────────┐
    │                     │          │                      │
┌───▼──────┐  ┌──▼──────┐  ┌────▼────┐  ┌───▼──────┐  ┌─────▼─────┐
│Investigate│  │Note    │  │Manager │  │Solve    │  │Response   │
│  Agent  │  │Agent  │  │ Agent  │  │ Agent   │  │  Agent    │
└─────────┘  └────────┘  └────┬────┘  └───┴──────┘  └───────────┘
                                   │
                            ┌──────┴──────┐
                            │   ToolAgent  │
                            │  (工具调用)  │
                            └─────────────┘
```

**Analysis Loop (分析循环)**
- `InvestigateAgent`: 问题调查、信息收集
- `NoteAgent`: 笔记生成、知识沉淀

**Solve Loop (求解循环)**
- `ManagerAgent`: 任务分解、智能体协调
- `SolveAgent`: 问题求解、答案生成
- `ToolAgent`: 工具调用执行
- `ResponseAgent`: 响应格式化
- `PrecisionAnswerAgent`: 精确答案验证

### 5.3 多智能体协作模式

#### 5.3.1 协作模式 1：顺序执行

```
Input → [Agent 1] → Output1 → [Agent 2] → Output2 → [Agent 3] → Final Output
```

示例：Research 模块
```
用户查询 → [RephraseAgent] → 重写查询
         → [DecomposeAgent] → 分解子问题
         → [ResearchAgent] → 研究子问题
         → [NoteAgent] → 生成笔记
         → [ReportingAgent] → 生成报告
```

#### 5.3.2 协作模式 2：并行执行

```
         [Agent 1]
                │
Input ────┼─── [Agent 2] ───→ Merge Results
                │
         [Agent 3]
```

示例：RAG 检索
```
查询 ───→ [关键词检索] ──┐
        ───→ [语义检索]   ───→ 结果合并 → 重排序
        ───→ [混合检索] ──┘
```

#### 5.3.3 协作模式 3：层级协调

```
              [Manager Agent]
                   │
        ┌──────────┼──────────┐
        │          │          │
    [Tool 1]   [Tool 2]   [Tool 3]
        │          │          │
        └──────────┴──────────┘
                   │
           [Response Agent]
```

### 5.4 多智能体协作的意义

| 优势 | 说明 |
|------|------|
| **模块化** | 每个 Agent 专注单一职责，易于维护和测试 |
| **可扩展** | 新增 Agent 不影响现有代码 |
| **灵活性** | 可以动态启用/禁用特定 Agent |
| **可组合** | 不同 Agent 可以组合解决复杂问题 |
| **容错性** | 单个 Agent 失败不影响整体系统 |
| **专业化** | 不同 Agent 针对特定任务优化 |

---

## 6. Memory 系统

### 6.1 Memory 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                      Memory System (记忆系统)                    │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌─────────────────┐  ┌──────────────────┐  ┌─────────────────┐  │
│  │  UserProfile    │  │ SessionSummary  │  │ MemoryEmbedding │  │
│  │  (用户画像)       │  │  (会话摘要)     │  │  (向量嵌入)      │  │
│  └─────────────────┘  └──────────────────┘  └─────────────────┘  │
│           │                    │                    │           │
│           ▼                    ▼                    ▼           │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │              PostgreSQL + pgvector                           │  │
│  └─────────────────────────────────────────────────────────────┘  │
│                                                               │
└───────────────────────────────────────────────────────────────┘
```

### 6.2 数据模型

#### UserProfile (用户画像)

```python
class UserProfile(Base):
    user_id: str              # 用户唯一标识
    preferences: JSON          # 学习偏好
        - learning_style        # 学习风格 (visual/textual/hands_on/code_first)
        - difficulty_preference  # 难度偏好 (beginner/intermediate/advanced)
        - language              # 界面语言
        - include_code          # 是否包含代码
        - include_math          # 是否包含数学
    statistics: JSON          # 学习统计
        - total_sessions       # 总会话数
        - total_questions      # 总问题数
        - active_days          # 活跃天数
        - avg_session_length   # 平均会话长度
    knowledge_graph: JSON      # 知识图谱
        - [concept]: {mastery_level, last_reviewed, ...}
    weak_points: JSON          # 薄弱知识点
        - [{concept, confusion_score, reason}]
    interests: List           # 兴趣领域
```

#### SessionSummary (会话摘要)

```python
class SessionSummary(Base):
    session_id: str           # 会话 ID
    user_id: str              # 用户 ID
    core_topic: str           # 核心主题
    key_points: List[str]      # 关键知识点
    resolved_questions: List[str]  # 已解决问题
    unresolved_questions: List[str]  # 未解决问题
    user_preferences: JSON    # 推断出的用户偏好
    weak_points: JSON         # 薄弱知识点
    subject: str              # 学科
    topic: str                # 主题
    difficulty: str           # 难度
    recent_messages: List     # 最近的消息（用于恢复上下文）
    message_count: int        # 消息数量
```

### 6.3 Memory 触发机制

```python
# 触发条件（.env.memory 配置）
SUMMARY_TRIGGER_ROUNDS = 3    # 对话轮数
SUMMARY_TRIGGER_TOKENS = 4000  # Token 数量

# 触发时机
1. WebSocket 连接关闭时
2. 消息数 >= trigger_rounds * 2 (3轮 = 6条消息)
3. Token 数 >= trigger_tokens
```

---

## 7. 数据流动详解

### 7.1 对话过程中的数据流

```
┌──────────────────────────────────────────────────────────────────┐
│                        用户发起对话 "苏轼是谁？"                   │
└─────────────────────────────┬────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│  浏览器 localStorage                                        │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ deeptutor-user-id: "user_1768630929559_vsp84m6"                │ │
│  └───────────────────────────────────────────────────────────┘ │
│                        │                                       │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌──────────────────────────────────────────────────────────────────┐
│  WebSocket 请求                                               │
│  {                                                             │
│    "message": "苏轼是谁？",                                     │
│    "session_id": null,                                       │
│    "user_id": "user_1768630929559_vsp84m6",                    │
│    "enable_rag": false,                                     │
│    "enable_web_search": false                               │
│  }                                                            │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌──────────────────────────────────────────────────────────────────┐
│  FastAPI /api/v1/chat WebSocket                              │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ 1. 创建 ChatAgent                                        │ │
│  │    agent = ChatAgent(                                  │ │
│  │        user_id="user_1768630929559_vsp84m6",              │ │
│  │        session_id="chat_xxx",                           │ │
│  │        enable_memory=True                                │ │
│  │    )                                                     │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                        │                                       │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ 2. Memory 检索 (并行)                                   │ │
│  │    ┌───────────────────────────────────────────────────────┐ │ │
│  │    │ RetrievalAgent.process(                             │ │ │
│  │    │   user_id,                                       │ │ │
│  │    │   query="苏轼是谁？",                              │ │ │
│    │    │   days=7                                        │ │ │ │
│  │    │ )                                               │ │ │
│  │    │  ┌──────────────────────────────────────────────┐  │ │ │
│  │  │  │ 1. 查询 user_profiles 表                         │  │ │ │
│  │  │  │ 2. 查询 session_summaries 表                    │  │ │ │
│  │  │  │ 3. 构建 memory_text                            │  │ │ │
│  │  │  │ 4. LLM 生成上下文                              │ │ │ │
│  │  │  └──────────────────────────────────────────────┘  │ │ │
│  │  └───────────────────────────────────────────────────────┘ │ │
│  │        context = "用户画像: ..., 历史记忆: ..."          │ │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                        │                                       │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ 3. 构建 messages                                         │ │
│  │    messages = [                                          │ │
│  │        {"role": "system", "content": system_prompt},     │ │
│  │        {"role": "system", "content": context},           │ │
│  │        ...history...,                                    │ │
│  │        {"role": "user", "content": "苏轼是谁？"}            │ │
│  │    ]                                                     │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                        │                                       │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ 4. LLM 流式调用                                         │ │
│  │    stream_llm(                                          │ │
│  │        model="glm-4-flash",                             │ │
│  │        messages=messages,                                │ │ │
│  │        stream=True                                      │ │ │
│  │    )                                                     │ │ │
│  │    ┌──────────────────────────────────────────────────────┐ │ │
│  │    │ LLM Factory (多提供商路由)                          │ │ │
│  │    │  ┌──────────┐  ┌──────────┐  ┌───────────┐  │ │ │
│  │    │  │OpenAI   │  │Anthropic│  │智谱AI    │  │ │ │
│  │    │  │Provider│  │Provider│  │Provider  │  │ │ │
│  │    │  └─────────┘  └─────────┘  └───────────┘  │ │ │
│  │    │  │  │              │             │           │ │ │ │ │
│  │    │  └──►──────►───────►───────────►───────┐     │ │ │ │
│  │    │                                             │     │ │ │ │
│  │    │  ┌───────────────────────────────────────┐  │ │ │ │ │
│  │  │  │        chunks ("苏轼", "是", "...")        │  │ │ │ │
│  │    │  └───────────────────────────────────────┘  │ │ │ │ │
│  │    │                                             │     │ │ │ │ │
│  │    └─────────────────────────────────────────────┘     │ │ │ │
│  │    │                               │                          │ │ │ │
│  │    └───────────────────────────────┬─────────────────┘ │ │ │
│  │                                        │                          │ │ │ │
│  │  ┌───────────────────────────────────────▼─────────────┐ │ │ │ │
│  │  │ {"type": "stream", "content": "苏轼"}              │ │ │ │ │
│  │  │ {"type": "stream", "content": "是"}                  │ │ │ │ │
│  │  │ {"type": "stream", "content": "..."}                  │ │ │ │ │
│  │  │ {"type": "complete", "response": "..."}             │ │ │ │ │
│  │  └──────────────────────────────────────────────────────┘ │ │ │ │
│  └─────────────────────────────────────────────────────────────┘ │ │
│                        │                                       │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ 5. 保存到 SessionManager                                  │ │
│  │    session_manager.add_message(role="assistant", content=...)│ │
│  └─────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────┘
                         │
                         ▼
┌──────────────────────────────────────────────────────────────────┐
│  用户关闭连接 (后台触发)                                         │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ 1. 检查消息数量 >= 6?                                 │ │
│  │    if len(messages) >= 6:                               │ │
│  │        trigger_summary()                               │ │
│  │                                                         │ │
│  │ 2. SummarizerAgent 生成摘要                              │ │
│  │    - LLM JSON Mode                                        │ │
│  │    - 输出: {core_topic, key_points, ...}               │ │
│  │                                                         │ │
│  │ 3. ProfileAgent 更新用户画像                              │
│  │    - 推断学习偏好                                        │ │
│  │    - 更新统计数据                                        │ │
│  │                                                         │
│  │ 4. 保存到 PostgreSQL                                      │ │
│ │    - user_profiles (用户画像)                            │ │
│  │    - session_summaries (会话摘要)                       │ │
│  └─────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────┘
```

### 7.2 用户画像更新流程

```
┌──────────────────────────────────────────────────────────────────┐
│  对话结束后，ProfileAgent 分析对话内容                        │
└─────────────────────────────┬────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│  ProfileAgent._infer_preferences()                           │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ 1. 格式化消息                                         │ │ │
│  │    messages_text = "[USER]: ... \n[ASSISTANT]: ..."      │ │ │
│  │                                                         │ │ │
│  │ 2. 构建 prompt                                        │ │ │
│ │    "分析用户偏好... 对话内容: {messages}"            │ │ │
│  │                                                         │ │ │
│  │ 3. LLM 调用 (JSON mode)                               │ │ │
│ │    call_llm(response_format={"type": "json_object"})    │ │ │
│  │                                                         │ │ │
  │  4. 解析响应                                            │ │ │
│ │    {                                                  │ │ │
│ │      "learning_style": "textual",                      │ │ │
│ │      "difficulty_preference": "beginner",               │ │ │ │ │ │
│ │      "confidence": 0.8                                 │ │ │ │
│ │    }                                                  │ │ │ │
│  └─────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│  更新 user_profiles 表                                         │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │  preferences JSON: {                                    │ │ │
│  │    "learning_style": "textual",                          │ │ │
│  │    "difficulty_preference": "beginner"                  │ │ │
│  │    "language": "zh-CN",                                │ │ │ │ │ │
│  │    ...                                                    │ │ │ │ │ │
│  │  }                                                     │ │ │ │ │ │
│  └─────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────┘
```

---

## 8. 总结

DeepTutor 是一个设计精良的 AI 教育系统，其核心特点包括：

1. **统一的 BaseAgent 架构**：所有智能体共享基础设施，代码复用性高
2. **多智能体协作**：不同模块使用不同的 Agent 组合，灵活高效
3. **Memory 系统**：实现跨会话记忆，提供个性化学习体验
4. **微服务架构**：前后端分离，模块化设计，易于扩展维护
5. **流式响应**：提供流畅的用户体验
6. **多提供商支持**：灵活切换 LLM 提供商，降低成本

这种架构设计使得 DeepTutor 能够：
- 快速添加新功能模块
- 高效处理复杂的教育场景
- 提供个性化的学习体验
- 保持代码的可维护性和可扩展性
